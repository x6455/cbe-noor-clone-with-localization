name: Flutter CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.19.0'  # Use specific version to avoid surprises

      - name: Check Flutter version
        run: flutter --version

      - name: Try dependency resolution
        run: |
          # First attempt with current pubspec
          flutter pub get || {
            echo "Dependency resolution failed, attempting to fix..."
            
            # Backup pubspec
            cp pubspec.yaml pubspec.yaml.backup
            
            # Update intl dependency inline
            sed -i 's/intl: \^0.17.0/intl: ^0.20.2/g' pubspec.yaml
            
            # Try again
            flutter pub get || {
              echo "Still failing, using backup..."
              mv pubspec.yaml.backup pubspec.yaml
              exit 1
            }
          }

      - name: Run dart fix for null safety
        run: |
          dart fix --apply || echo "Dart fix failed or not needed"

      - name: Verify formatting
        run: flutter format --set-exit-if-changed .

      - name: Analyze project source
        run: flutter analyze

      - name: Run tests
        run: flutter test

      - name: Build for Android
        run: flutter build apk --release

      - name: Build for Web
        run: flutter build web --release
